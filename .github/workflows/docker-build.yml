name: Build with Docker Compose

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Step 2: Install Docker Compose
    - name: Install Docker Compose
      run: |
        echo "ðŸ“¦ Installing Docker Compose..."
        sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version
        
    # Step 3: Build with Docker Compose
    - name: Build Docker images
      run: |
        echo "ðŸš€ Building Docker images..."
        docker-compose build
        
        echo "âœ… Images built:"
        docker images
        
    # Step 4: Save images
    - name: Save images as tar files
      run: |
        echo "ðŸ’¾ Saving images..."
        
        # Get all images starting with crud-rental-properties
        IMAGE_NAMES=$(docker images --format "{{.Repository}}" | grep "crud-rental-properties" | uniq)
        
        for image_name in $IMAGE_NAMES; do
          # Get the latest tag for this image
          LATEST_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${image_name}:" | head -1)
          if [ -n "$LATEST_TAG" ]; then
            filename="${image_name//\//_}.tar"
            echo "Saving $LATEST_TAG as $filename"
            docker save -o $filename $LATEST_TAG
          fi
        done
        
        echo "ðŸ“¦ Files created:"
        ls -la *.tar || echo "No tar files created"
        
    # Step 5: Upload artifacts
    - name: Upload Docker images
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: docker-images
        path: |
          *.tar
        retention-days: 7
        
    # Step 6: Build report
    - name: Create Build Report
      run: |
        echo "# Docker Compose Build Report" > build-report.md
        echo "## Status: SUCCESS" >> build-report.md
        echo "## Timestamp: $(date)" >> build-report.md
        echo "## Commit: ${{ github.sha }}" >> build-report.md
        echo "## Workflow: ${{ github.workflow }}" >> build-report.md
        echo "" >> build-report.md
        echo "## Environment:" >> build-report.md
        echo "- Docker: $(docker --version)" >> build-report.md
        echo "- Docker Compose: $(docker-compose --version)" >> build-report.md
        echo "" >> build-report.md
        echo "## Command Executed:" >> build-report.md
        echo "\`\`\`bash" >> build-report.md
        echo "docker-compose build" >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "## Docker Images Created:" >> build-report.md
        echo "\`\`\`" >> build-report.md
        docker images >> build-report.md
        echo "\`\`\`" >> build-report.md
        
    # Step 7: Upload report
    - name: Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-documents
        path: build-report.md
        
    # Step 8: Success message
    - name: Build Complete
      run: |
        echo "ðŸŽ‰ BUILD STAGE COMPLETE!"
        echo "âœ… Docker Compose build successful"
        echo "ðŸ“¦ Check Artifacts section to download images"